<script>
    /**
     * Behavior, um einem beliebigen Formular (Update, Create, Read) alle Eigenschaften
     * wie Properties und Methoden zu geben, die es benötigt um mit dem Server zu 
     * kommunizieren.
     * 
     * @polymerMixinClass
     */
    let AnimadFormBehavior = (superclass) => class extends superclass {

        static get properties() {
            return {
                /**
                 * Url um die Formulardaten zu laden.
                 */
                getUrl: {
                    type: String
                },
                /**
                 * Url an die die Formulardaten gesendet werden.
                 */
                postUrl: {
                    type: String
                },
                i18nContext: {
                    type: String
                },
                /**
                 * Das leere Objekt.
                 *   
                 * @type{}
                 */
                _data: {
                    type: Object,
                    value() {
                        return {}
                    }
                },
                /**
                 *
                 */
                _error: {
                    type: String
                },
                /**
                 *
                 */
                _errorToast: {
                    type: Object,
                    value() {
                        return document.querySelector('#global_error_toast');
                    }
                },
                /**
                 *
                 */
                _successToast: {
                    type: Object,
                    value() {
                        return document.querySelector('#global_success_toast');
                    }
                },
                /**
                 *
                 */
                 _warningToast: {
                    type: Object,
                    value() {
                        return document.querySelector('#global_warning_toast');
                    }
                }
            }
        }

        /**
         * Validiert die Formulardaten. Danach werden sie an die angegebene
         * URL als JSON Objekt gesendet.
         */
        _sendForm() {
            // check if the formcontent is valid against the defined rules
            var valid = this.shadowRoot.querySelector(this._formid).validate();

            if (valid) {
                // console print TODO delete this
                this.foo = JSON.stringify(this._data);
                console.log("form is valid: " + this.foo);

                // prepare request
                var init = {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify(this._data)
                }

                var request = new Request(this.postUrl, init);

                fetch(request)
                    .then(response => {
                        if (response.ok) {
                            this._resetForm();
                            this._success(response.json());
                        } else {
                            this._error(response.status);
                        }
                    })
            } else {
                console.log("form is not valid...");
                var i18nCreateValidation = this.i18nContext + '_form_validation';
                this._warningToast.text = this.resources[this.lang][i18nCreateValidation];
                this._warningToast.open();
            }

        }

        /*
         * Lädt die Daten über die definierte URL. Die Daten
         * werden im Property '_data' gespeichert.
         */
        _loadFormData() {
            var init = {
                method: 'GET',
                // headers
                mode: 'cors',
                cache: 'default'
            };

            // create request object
            var request = new Request(this.getUrl, init);

            // call the server
            fetch(request)
            .then(response => {
                if(response.ok) {
                    //console.log(response);
                    response.json().then(body => {
                        // Bei Erfolg werden die Daten, die vom Server kommen 
                        // im '_data' Property gespeichert.
                        this.set('_data', body);
                    }) 
                } else {
                    this._error(response.status);
                }
            })
        }

        /**
         * Setzt das Formular zurück.
         */
        _resetForm() {
            this.shadowRoot.querySelector(this._formid).reset();
        }

        /**
         * Der 'Toast', der bei Erfolg angezeigt wird.
         */
        _success(result) {
            var i18nCreateSuccess = this.i18nContext + '_form_success';
            this._successToast.text = this.resources[this.lang][i18nCreateSuccess];
            this._successToast.open();
        }

        /**
         * Der 'Toast', der bei Fehlern angezeigt wird.
         */
        _error(status) {
            var i18nCreateError = this.i18nContext + '_form_error';
            this._errorToast.text = this.resources[this.lang][i18nCreateError] + ' ' + status;
            this._errorToast.open();
        }
    };
</script>