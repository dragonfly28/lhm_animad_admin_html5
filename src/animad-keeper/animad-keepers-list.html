<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/nebula-i18n/nebula-i18n.html">
<link rel="import" href="../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-filter.html">

<link rel="import" href="../animad-icons.html">
<link rel="import" href="../behaviors/animad-list-behavior.html">
<link rel="import" href="../behaviors/animad-i18n-behavior.html">
<link rel="import" href="../behaviors/mixin.html">
<link rel="import" href="./animad-list-header.html">

<!-- GENERATOR pattern: [DOMAINNAME]-[ENTITYNAME]-list -->
<dom-module id="animad-keepers-list">
    <template>
      <style>
      </style>

      <animad-list-header
          placeholder-search="[[t('filter_placeholder')]]"
          placeholder-delete="Löschen"
          placeholder-new="Neu"
          all-filters="[[localizedFilters]]"
          selected-filters = "{{_selectedFilters}}"
          search="{{_search}}"
          on-search="filterData"
          on-filter="filterKeepers"
          on-delete="confirmDeleteSelected"
          on-new="handleNew"
          disable-delete-button="[[disableDeleteButton]]"
        >
      </animad-list-header>


      <!--
        Modaler Dialog zur Abfrage vor dem Löschen von in der Liste über Checkboxen selektierten Datensätze
      -->
      <paper-dialog id="dialogDeleteSelected">
        <h2>[[t('modal_delete_header')]]</h2>
        <p>[[t('modal_delete_text_multi')]]</p>
        <paper-item>
          <paper-button raised dialog-confirm on-click="deleteSelectedRows">[[t('modal_delete_button_yes')]]</paper-button>
          <paper-button raised dialog-dismiss autofocus>[[t('modal_delete_button_no')]]</paper-button>
        </paper-item>
      </paper-dialog>

      <!--
        Modaler Dialog zur Abfrage vor dem Löschen eines Datensatzes über Papierkorb
      -->
      <paper-dialog id="dialogDeleteItem">
        <h2>[[t('modal_delete_header')]]</h2>
        <p>[[t('modal_delete_text_single')]] ([[_deleteInfo]])?</p>
        <paper-item>
          <paper-button raised dialog-confirm on-click="deleteSelectedRows">[[t('modal_delete_button_yes')]]</paper-button>
          <paper-button raised dialog-dismiss on-click="unsetTemporaryDeleteInfo" autofocus>[[t('modal_delete_button_no')]]</paper-button>
        </paper-item>
      </paper-dialog>

      <!--
      // GENERATOR pattern (camel case): [DOMAINNAME][ENTITYNAME]List - id
      // GENERATOR pattern:             _filtered[ENTITYNAME] - items
      -->
      <vaadin-grid id="vgrid" items="[[filteredData]]" multi-sort="[[multiSort]]" selected-items="{{selectedItems}}">
        <vaadin-grid-selection-column auto-select>
        </vaadin-grid-selection-column>

        <vaadin-grid-column width="50px" flex-grow="0" >
          <template class="header">#</template>
          <template>[[index]]</template>
        </vaadin-grid-column>


        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="firstname">[[t('firstname')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.firstname]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column >
          <template class="header">
            <vaadin-grid-sorter path="lastname">[[t('lastname')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.lastname]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="employmentdate">[[t('employmentdate')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.employmentdate]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="skill">[[t('skill')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.skill]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="birthdate">[[t('birthdate')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.birthdate]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="salary">[[t('salary')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.salary]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template>
            <paper-icon-button icon="animad-icons:delete" id="[[index]]" on-click="confirmDeleteRow"></paper-icon-button>
          </template>
        </vaadin-grid-column>
      </vaadin-grid>
    </template>

    <script>
      // GENERATOR pattern (camel case): [DOMAINNAME][ENTITYNAME]List
      class AnimadKeepersList extends mix(Polymer.Element).with(AnimadListBehavior, AnimadI18nBehavior) {

        static get is() { return 'animad-keepers-list'; }

        static get properties() {
          return {
            /*
             * Das '_domain' property wird benötigt, um" den richtigen Pfad
             * zu den i18n Werten zu erzeugen. Es wird in jedem Element
             * benötigt, in dem die I18nBehavior verwendet wird. Im Falle
             * einer view ist der Wert IMMER 'view'.
             */
            _domain: {
              type: String,
              value: 'animad'
            },
            /*
             * Das '_entity' property wird benötigt, um den richtigen Pfad
             * zu den i18n Werten zu erzeugen. Es wird in jedem Element
             * benötigt, in dem die I18nBehavior verwendet wird. Im Falle
             * einer view ist der Wert immer der Präfix, der im Namen der view
             * vor '*-view' steht. Bei animad-enclosures-view.html also
             * 'animad-enclosures'.
             */
            _entity: {
              type: String,
              value: 'keeper'
            },
            /*
              allFilters sind optionale (leeres Array), selektierbare Filter. Sie werden über ein Array definiert, Das
              die Struktur [{id, [{id, label}, {id2, label2}, ...}, {id2, [{id, label}, ...]}, ...] einhalten muss.
              GENERATOR: allFilters kann auch ein leeres Array [] enthalten. Dann wird der Filter-Button im search-panel nicht angezeigt.
            */
            allFilters: {
              type: Array,
              value() {
                return [
                  {
                    id: "birthdate",
                    filters: [
                      {id: "0", label: "filter_birthdate_before_1980"},
                      {id: "1", label: "filter_birthdate_1980_1990"},
                      {id: "2", label: "filter_birthdate_after_1990"}
                    ]
                  },
                  {
                    id: "salary",
                    filters: [
                      {id: "0", label: "filter_salary_less_1000"},
                      {id: "1", label: "filter_salary_1000_2000"},
                      {id: "2", label: "filter_salary_2000_3000"},
                      {id: "3", label: "filter_salary_more_3000"}
                    ]
                  }
                ]
              },
              /*
                allFiltersLocalized entspricht allFilters, aber die Werte in 'label' sind durch lokalisierte Werte ersetzt worden.
              */
              localizedFilters: {
                type: Array,
                value() {
                  return this.allFilters;
                }
              }
            },
            /*
              _selectedFilters enthält die Information über alle ausgewählten Filter.
            */
            _selectedFilters: {
              type: Array,
              value() {
                return [];
              }
            },
            /*
              _search enthält den String, der im Sucheingabe-Feld zum Filtern eingegeben wurde.
            */
            _search: {
              type: String,
              value: ""
            },
            /*
              multiSort gibt an, ob in der Tabelle nach mehreren Feldern sortiert
              werden kann (multiSort = true) oder nicht (multiSort = false)
            */
           multiSort: {
             type: Boolean,
             value: false
           },
           selectedItems: {
             type: Array,
             value() {
               return [];
             }
           },
           disableDeleteButton: {
             type: Boolean,
             value: true
           }
         }
        }

        // Observe changes to allFilters array
        static get observers() {
          return [
            'initLocalizedFilter(allFilters)',
            'selectionChanged(selectedItems.length)'
          ]
        }

        selectionChanged(nrSelectedItems){
          this.disableDeleteButton = (nrSelectedItems === 0);
        }

        // localize all allFilters.filters.label
        initLocalizedFilter(allFilters){
          var localizedFilters = []
          for (var i in allFilters){
            var filters = allFilters[i].filters;
            for (var j in filters){
              filters[j].label = this.t(filters[j].label);
            }
          }
          this.localizedFilters = allFilters;
        }

        handleNew() {
          console.log("handleNew");
          // TBD
        }

        deleteSelectedRows() {
          var selectedItems = [];

          if (this._deleteItem.length > 0) {
            // delete single item (basket button in row)
            selectedItems = this._deleteItem;
          }
          else {
            // delete all shown selected items (delete button on top of grid)
            selectedItems = this.selectedItems;
          }

          // loop over all items to delete
          for (var i in selectedItems) {
            // check if filteredData contains selectedItems[i]
            var index = this.filteredData.indexOf(selectedItems[i]);

            if (index >= 0) {

              // TBD: Daten im Backend löschen -> data
              var j = this.data.indexOf(selectedItems[i]);
              this.splice('data', j, 1);
            }
          }

          // loop must be backwards to deselect all selected items that were deleted
          for (var i = selectedItems.length-1; i >= 0; i-- ) {
            this.$.vgrid.deselectItem(selectedItems[i]);
          }

          // unset temporary delete information
          this.unsetTemporaryDeleteInfo();

          this.filterKeepers();
        }

        confirmDeleteSelected() {
          // check if selected item should be deleted
          // attention: this.$ necessary to enable it for Opera (https://github.com/PolymerElements/paper-dialog/issues/128)
          this.$.dialogDeleteSelected.open();
        }

        confirmDeleteRow(e) {
          // get item of row where delete button was clicked
          var item = this.filteredData[e.target.id];

          // set temporary delete information
          this._deleteInfo = this.t('modal_deleteinfo', {firstname: item.firstname, lastname: item.lastname, employmentdate: item.employmentdate, skill: item.skill,   birthdate: item.birthdate,  salary: item.salary});
          this._deleteItem = [item];

          // user must confirm that item should be deleted
          // attention: this.$ necessary to enable it for Opera (https://github.com/PolymerElements/paper-dialog/issues/128)
          this.$.dialogDeleteItem.open();
        }

        filterKeepers() {
          this.filter();
        }

        filterData(event) {
          this._search = event.target.search.toLowerCase();
          this.filter();
        }

        filter(){
          this.filteredData =
            this.data.filter(keeper =>
                keeper.firstname.toLowerCase().includes(this._search) ||
                keeper.lastname.toLowerCase().includes(this._search) ||
                keeper.employmentdate.toLowerCase().includes(this._search) ||
                keeper.skill.toLowerCase().includes(this._search) ||
                keeper.birthdate.toLowerCase().includes(this._search) ||
                new String(keeper.salary).toLowerCase().includes(this._search));
          this.filteredData = this.filteredData.filter(this.useSelectedFilters, this);
        }

        useSelectedFilters(keeper) {
          var isIncluded = true;
          for (var filterObject of this._selectedFilters) {
            switch (filterObject.type) {
              case this.allFilters[0].id: // for the example: birthdate
                switch (filterObject.filter.id) {
                  case this.allFilters[0].filters[0].id:
                    console.log("Implementation for "+ this.allFilters[0].id + "," + this.allFilters[0].filters[0].label);
                    break;
                  case this.allFilters[0].filters[1].id:
                    console.log("Implementation for "+ this.allFilters[0].id + "," + this.allFilters[0].filters[1].label);
                    break;
                  case this.allFilters[0].filters[2].id:
                    console.log("Implementation for "+ this.allFilters[0].id + "," + this.allFilters[0].filters[2].label);
                    break;
                  default:
                    console.log("Filter not defined");
                    break;
                }
                break;
              case this.allFilters[1].id: // for the example: salary
                switch (filterObject.filter.id) {
                  case this.allFilters[1].filters[0].id:
                    console.log("Implementation for "+ this.allFilters[1].id + "," + this.allFilters[1].filters[0].label);
                    isIncluded = isIncluded && keeper.salary <= 1000;
                    break;
                  case this.allFilters[1].filters[1].id:
                    console.log("Implementation for "+ this.allFilters[1].id + "," + this.allFilters[1].filters[1].label);
                    break;
                  case this.allFilters[1].filters[2].id:
                    console.log("Implementation for "+ this.allFilters[1].id + "," + this.allFilters[1].filters[2].label);
                    break;
                  case this.allFilters[1].filters[3].id:
                    console.log("Implementation for "+ this.allFilters[1].id + "," + this.allFilters[1].filters[3].label);
                    break;
                  default:
                    console.log("Filter not defined");
                    break;
                }
                break;
              default:
                console.log("Filter not defined");
                return true;
            }

          }
          return isIncluded;
        }
      }

      customElements.define(AnimadKeepersList.is, AnimadKeepersList);
    </script>

  </dom-module>
