<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-search/paper-search-panel.html">
<link rel="import" href="../../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/array-selector.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/nebula-i18n/nebula-i18n.html">
<link rel="import" href="../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../animad-icons.html">

<!-- GENERATOR pattern: [DOMAINNAME]-[ENTITYNAME]-list -->
<dom-module id="animad-keepers-list">
    <style>
    </style>

    <template>
      <nebula-language
          supported='["en", "de"]'
          lang="{{lang}}">
      </nebula-language>
      <nebula-resources
              id="locales"
              file="animad_keepers_locales"
              path="/locales"
              resources="{{resources}}">
      </nebula-resources>

      <!--
        Search panel, NEW and DELETE functionality
      -->
      <paper-item id="list-panel-1">
        <paper-item-body>

          <paper-search-bar
            placeholder = "[[$t('animad_keepers_filter_placeholder')]] (paper-search-bar)"
            hide-filter-button = "[[_hideFilterButton]]"

            items = "{{_filteredKeepers}}"
            on-query-changed="setFilteredKeepersBar"
            on-paper-search-filter = "setSearchFilter"
            >
          </paper-search-bar>

          <iron-collapse id="filterSelection" opened={{_openedFilterSelection}}>
            <div>
              <div>
                <paper-checkbox checked>Filter by Last</paper-checkbox>
              </div>
              <div>
                <paper-checkbox checked>Filter by First</paper-checkbox>
              </div>
              <div>
                <div>
                  Alter
                  <div>
                    <paper-checkbox >jünger als 30 Jahre</paper-checkbox>
                  </div>
                  <div>
                    <paper-checkbox >30-49 Jahre</paper-checkbox>
                  </div>
                  <div>
                    <paper-checkbox >älter als 50 Jahre</paper-checkbox>
                  </div>
                </div>
              </div>
            </div>
          </iron-collapse>
        </paper-item-body>

        <paper-button raised on-click="handleNew">New</paper-button>
        <paper-button raised onclick="dialogDeleteSelected.open()">Delete</paper-button>
      </paper-item>

      <paper-item id="list-panel-2">
        <paper-item-body>
          <paper-search-panel
            search = "{{_search}}"
            items = "{{_filteredKeepers}}"
            on-change-request-params="setFilteredKeepersPanel"
            hide-filter-button = "[[_hideFilterButton]]"
            placeholder = "[[$t('animad_keepers_filter_placeholder')]] (paper-search-panel)"
            no-results-text = "[[$t('animad_keepers_filter_no_results_text')]]"
            filters = "[[_allFilters]]"
            reset-button = "[[$t('animad_keepers_filter_button_reset')]]"
            save-button = "[[$t('animad_keepers_filter_button_save')]]"
            no-values-label = "[[$t('animad_keepers_filter_label_no_values')]]"
            more-button = "[[$t('animad_keepers_filter_button_more')]]"
            paper-search-filter = "setSearchFilter"
            >
          </paper-search-panel>

        </paper-item-body>
        <paper-button raised on-click="handleNew">New</paper-button>
        <paper-button raised onclick="dialogDeleteSelected.open()">Delete</paper-button>
      </paper-item>

      <!--
        Modal dialog to ask before deleting all selected items
      -->
      <paper-dialog id="dialogDeleteSelected">
        <h2>[[$t('animad_keepers_modal_delete_header')]]</h2>
        <p>[[$t('animad_keepers_modal_delete_text_multi')]]</p>
        <paper-item>
          <paper-button raised dialog-confirm on-click="deleteSelectedRows">[[$t('animad_keepers_modal_delete_button_yes')]]</paper-button>
          <paper-button raised dialog-dismiss autofocus>[[$t('animad_keepers_modal_delete_button_no')]]</paper-button>
        </paper-item>
      </paper-dialog>

      <!--
        Modal dialog to ask before deleting all selected items
      -->
      <paper-dialog id="dialogDeleteItem">
        <h2>[[$t('animad_keepers_modal_delete_header')]]</h2>
        <p>[[$t('animad_keepers_modal_delete_text_single')]] ([[_deleteInfo]])?</p>
        <paper-item>
          <paper-button raised dialog-confirm on-click="deleteSelectedRows">[[$t('animad_keepers_modal_delete_button_yes')]]</paper-button>
          <paper-button raised dialog-dismiss on-click="unsetTemporaryDeleteInfo" autofocus>[[$t('animad_keepers_modal_delete_button_no')]]</paper-button>
        </paper-item>
      </paper-dialog>

      <!--
      // GENERATOR pattern (camel case): [DOMAINNAME][ENTITYNAME]List - id
      // GENERATOR pattern :             _[ENTITYNAME] - items
      // GENERATOR pattern (camel case): filter[ENTITYNAME](_search) - filter
      // GENERATOR pattern (camel case): sort[ENTITYNAME](_currentSort.descending) - sort
      -->
      <vaadin-grid id="animadKeepersList" items="[[_filteredKeepers]]" multi-sort="[[multiSort]]">
        <vaadin-grid-selection-column auto-select>
        </vaadin-grid-selection-column>

        <vaadin-grid-column width="50px" flex-grow="0" >
          <template class="header">#</template>
          <template>[[index]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="first">[[$t('animad_keepers_first')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.first]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column >
          <template class="header">
            <vaadin-grid-sorter path="last">[[$t('animad_keepers_last')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.last]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="age">[[$t('animad_keepers_age')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.age]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template>
            <paper-icon-button icon="animad-icons:delete" id="[[index]]" on-click="deleteRow"></paper-icon-button>
          </template>
        </vaadin-grid-column>
      </vaadin-grid>
    </template>

    <script>
      // GENERATOR pattern (camel case): [DOMAINNAME][ENTITYNAME]List
      class AnimadKeepersList extends Nebula.PolyglotBehavior(Polymer.Element) {

        static get is() { return 'animad-keepers-list'; }

        static get properties() {
          // GENERATOR pattern _[ENTITYNAME]
          // GENERATOR pattern _filtered[ENTITNAME] (initially set to _[ENTITYNAME])
          // GENERATOR _sort Array contains an entry for each field of the ENTITY: {by: '[fieldname]', descending: true, upward: 'none', downward: 'none'}
          return {
            _keepers: {
              type: Array,
              value() {
                return [
                  {first: 'Patti', last: 'Smith', age: 32},
                  {first: 'Polly Jean', last: 'Harvey', age: 38},
                  {first: 'Joan', last: 'Jett', age: 62},
                  {first: 'Beth', last: 'Ditto', age: 27},
                  {first: 'Siouxsie', last: 'Sioux', age: 53},
                  {first: 'Lydia', last: 'Lunch', age: 32},
                  {first: 'Debbie', last: 'Harry', age: 57},
                  {first: 'Sadie', last: 'May', age: 22},
                  {first: 'Kim', last: 'Deal', age: 44},
                  {first: 'Kelly', last: 'Deal', age: 44},
                  {first: 'Courtney', last: 'Love', age: 56},
                  {first: 'Kathleen', last: 'Hanna', age: 34},
                  {first: 'Tobi', last: 'Vail', age: 28},
                  {first: 'Kathi', last: 'Wilcox', age: 32},
                  {first: 'Tanya', last: 'Donelly', age: 45},
                  {first: 'Laura Jane', last: 'Grace', age: 47},
                  {first: 'Donita', last: 'Sparks', age: 51},
                  {first: 'Suzi', last: 'Gardner', age: 20},
                  {first: 'Jennifer', last: 'Finch  ', age: 33},
                  {first: 'Demetra', last: 'Plakas', age: 47},
                ];
              }
            },
            _hideFilterButton: {
              type: Boolean,
              value: false
            },
            _allFilters: {
              type: Array,
              value() {
                return [
                  {id: "age", name: "Alter", values: [
                      {id: "age_1",name: "jünger als 30 Jahre"},
                      {id: "age_2", name: "30 - 49 Jahre"},
                      {id: "age_3",name: "älter als 50 Jahre"}
                    ]
                  }
                ]
              }
            },
            _search: {
              type: String,
              value: ""
            },
            _filteredKeepers: {
              type: Array,
              value() {
                return this._keepers;
              }
            },
            _openedFilterSelection: {
              type: Boolean,
              value: false
            },
           multiSort: {
             type: Boolean,
             value: false
           },
           _deleteInfo: {
             type: String,
             value: ""
           },
           _deleteItem: {
             type: Array,
             value: []
           }
         }
        }

        handleNew() {
          console.log("handleNew");
          // TBD
        }

        deleteSelectedRows(e) {
          var _selectedItems = [];
          var _tmpSelectedItems = [];

          if (this._deleteItem.length > 0) {
            _selectedItems = this._deleteItem;
            _tmpSelectedItems = _selectedItems;
          }
          else {
            _selectedItems = this.$.animadKeepersList.selectedItems;
          }
          // loop over all items to delete
          for (var i in _selectedItems) {
            // check if _filteredKeepers contains _selectedItems[i]
            var index = this._filteredKeepers.indexOf(_selectedItems[i]);

              // TBD: Daten im Backend löschen -> _keepers
            if (index >= 0) {
              this.splice('_filteredKeepers', index, 1);
            }
          }

          // unset temporary delete information
          this.unsetTemporaryDeleteInfo();

        }

        deleteRow(e) {
          // get item of row where delete button was clicked
          var item = this._filteredKeepers[e.target.id];

          // set temporary delete information
          this._deleteInfo = item.first+", "+item.last+", "+item.age;
          this._deleteItem = [item];

          // check if selected item should be deleted
          dialogDeleteItem.open();
        }

        unsetTemporaryDeleteInfo() {
          this._deleteItem = [];
          this._deleteInfo = "";
        }

        // GENERATOR pattern filter[ENTITYNAME]
        filterKeepers(val) {
          return function(item) {
            if (!item) return false;
            if (!val) return true;

            // GENERATOR über alle Felder des Objekts filtern: item.<feldname1>.includes || item.<feldname2>.includes || ...
            return (item.first.includes(val) || item.last.includes(val)) || item.age.toString().includes(val);
          }
        }

        // GENERATOR pattern (camel case): setFiltered[ENTITYNAME]
        setFilteredKeepersPanel(e) {
          this._filteredKeepers = this._keepers.filter(this.filterKeepers(e.target.search));
        }

        setFilteredKeepersBar(e) {
          this._filteredKeepers = this._keepers.filter(this.filterKeepers(e.target.query));
        }

        setSearchFilter(e) {
          console.log(this.$.collapse);
          this._openedFilterSelection = !this._openedFilterSelection;
        }
      }

      customElements.define(AnimadKeepersList.is, AnimadKeepersList);
    </script>

  </dom-module>
